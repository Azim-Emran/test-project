<!-- File: templates/index.html -->
{% extends 'layout.html' %} {% block content %}
<div class="container-fluid">
  <div class="row">
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="col-md-9">
      <h2 class="text-center mt-4 mb-4">
        üéì AI-Powered Personalized Learning Assistant
      </h2>

      <!-- Section: Ask AI Tutor -->
      <div id="gpt-section" class="card mb-4">
        <div class="card-header">Ask the AI Tutor</div>
        <div class="card-body">
          <div class="input-group mb-3">
            <input
              id="gpt-question"
              type="text"
              class="form-control"
              placeholder="Type your question here..."
            />
            <button class="btn btn-primary" onclick="askTutor()">Ask</button>
          </div>
          <div
            id="gpt-response"
            class="alert alert-info"
            style="display: none"
          ></div>
        </div>
      </div>

      <!-- Section: Adaptive Quiz -->
      <div id="quiz-section" class="card mb-4">
        <div class="card-header">Smart Quiz</div>
        <div class="card-body">
          <a href="{{ url_for('quiz') }}" class="btn btn-success">
            üß† Start Adaptive Quiz
          </a>

          <div id="question-box" class="mt-3"></div>
        </div>
      </div>

      <!-- Section: Recommendation -->
      <div id="recommend-section" class="card mb-4">
        <div class="card-header">Topic Recommendation</div>
        <div class="card-body">
          <button class="btn btn-warning" onclick="getRecommendation()">
            üîç Recommend Next Topic
          </button>
          <p id="recommended-topic" class="mt-2"></p>
        </div>
      </div>

      <!-- Section: Progress Dashboard -->
      <div id="dashboard-section" class="card mb-4">
        <div class="card-header">My Learning Dashboard</div>
        <div class="card-body">
          <canvas id="progressChart" height="120"></canvas>
        </div>
      </div>

      <!-- Section: Download Progress Report -->
      <div id="download-section" class="text-center mb-5">
        <button class="btn btn-outline-secondary" onclick="downloadProgress()">
          üì• Download Progress Report (CSV)
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function askTutor() {
    const question = document.getElementById("gpt-question").value;
    const responseBox = document.getElementById("gpt-response");
    fetch("/api/ask-gpt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: question, subject: "math" }),
    })
      .then((res) => res.json())
      .then((data) => {
        responseBox.innerText = data.response;
        responseBox.style.display = "block";
      });
  }

  function loadAdaptiveQuestion(topic) {
    fetch(`/api/get-adaptive-question/${topic}`)
      .then((res) => res.json())
      .then((data) => {
        if (data.error) return;
        const box = document.getElementById("question-box");
        box.innerHTML =
          `<strong>Q:</strong> ${data.question}<br>` +
          data.choices
            .map(
              (c) =>
                `<div><input type='radio' name='ans' value='${c}'> ${c}</div>`
            )
            .join("") +
          `<button class='btn btn-sm btn-primary mt-2' onclick=\"submitAnswer('${topic}', '${data.answer}')\">Submit</button>`;
      });
  }

  function submitAnswer(topic, correctAnswer) {
    const selected = document.querySelector("input[name='ans']:checked");
    if (!selected) return alert("Please choose an answer.");
    const isCorrect = selected.value === correctAnswer;
    const time_taken = Math.floor(Math.random() * 30) + 10;

    fetch("/api/submit-answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ topic, is_correct: isCorrect, time_taken }),
    }).then(() =>
      alert(isCorrect ? "‚úÖ Correct!" : "‚ùå Incorrect. Try again.")
    );
  }

  function getRecommendation() {
    fetch("/api/recommend-topic/1")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById(
          "recommended-topic"
        ).innerText = `üìò Your next recommended topic is: ${data.recommended_topic}`;
      });
  }

  let chartData = {};
  fetch("/api/get-progress")
    .then((res) => res.json())
    .then((data) => {
      chartData = data;
      const ctx = document.getElementById("progressChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.labels,
          datasets: [
            {
              label: "Accuracy (%)",
              data: data.accuracies,
              backgroundColor: "rgba(54,162,235,0.6)",
            },
          ],
        },
        options: {
          scales: { y: { beginAtZero: true, max: 100 } },
        },
      });
    });

  function downloadProgress() {
    let csv = "Topic,Accuracy (%)\n";
    for (let i = 0; i < chartData.labels.length; i++) {
      csv += `${chartData.labels[i]},${chartData.accuracies[i]}\n`;
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "progress_report.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
{% endblock %}
