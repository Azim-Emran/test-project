<!-- templates/quiz/start_quiz.html -->
{% extends 'layout.html' %}
{% block content %}

<div class="quiz-container mt-4">
  <h3>ğŸ“ Question {{ index }} of {{ total }}</h3>
  <p class="lead"><strong>{{ question.question_text | safe }}</strong></p>


  <form method="POST" action="{{ url_for('quiz_bp.submit_answer') }}" onsubmit="stopTimer()">
    <input type="text" name="user_answer" id="user_answer" required class="form-control" placeholder="Type your answer..." />
    <input type="hidden" name="correct_answer" value="{{ question['answer'] }}" />
    <input type="hidden" id="question_id" value="{{ question['id'] }}">
    <input type="hidden" id="quiz_type" value="topic">
    <input type="hidden" name="time_taken" id="time_taken" />
    <div class="mt-3">
      <button onclick="submitAnswer()" class="btn btn-success">Submit</button>
    </div>   
  </form>


  <div class="mt-3">
    {% if quiz_type == 'topic' %}
      <p class="hint text-info mt-3">ğŸ’¡ Hint: {{ question['hint'] }}</p>
    {% endif %}

    <p id="feedback" class="mt-2"></p>
    <p id="timer" class="text-danger mt-2"></p>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="endQuizModal" tabindex="-1" role="dialog" aria-labelledby="endQuizLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="endQuizLabel">ğŸ‰ Quiz Completed!</h5>
      </div>
      <div class="modal-body">
        You've finished the quiz. Great job!
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('quiz_bp.quiz_result') }}" class="btn btn-primary">View Results</a>
      </div>
    </div>
  </div>
</div>

<script>
let startTime = Date.now();

function updateTimer() {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  document.getElementById("timer").innerText = `ğŸ•’ Time elapsed: ${elapsed}s`;
  setTimeout(updateTimer, 1000);
}
updateTimer();

function submitAnswer() {
  const answer = document.getElementById("user_answer").value.trim();
  const questionId = document.getElementById("question_id").value;
  const quizType = document.getElementById("quiz_type").value;
  const timeTaken = Math.floor((Date.now() - startTime) / 1000);

  fetch("/submit_quiz", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      question_id: questionId,
      selected_answer: answer,
      quiz_type: quizType,
      time_taken: timeTaken
    })
  })
  .then(res => res.json())
  .then(data => {
    const feedback = document.getElementById("feedback");
    if (data.correct) {
      feedback.innerHTML = `<span class="text-success">âœ… Correct!</span>`;
    } else {
      feedback.innerHTML = `<span class="text-danger">âŒ Incorrect. Correct answer: <b>${data.correct_answer}</b></span>`;
    }

    setTimeout(() => {
      window.location.href = "/quiz/screen";
    }, 1500);
  })
  .catch(() => {
    alert("Something went wrong. Try again.");
  });
}

// Re-render math
if (window.MathJax) MathJax.typesetPromise();
</script>

{% endblock %}
