{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4">
  <h2>üìö My Quiz History</h2>

  <div class="mb-3 row align-items-center">
    <div class="col-sm-4">
      <label for="topicFilter" class="form-label">üéØ Filter by Topic</label>
      <select id="topicFilter" class="form-select">
        <option value="All">All Topics</option>
        {% for topic in topics %}
        <option value="{{ topic }}">{{ topic }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <table class="table table-bordered table-hover mt-3" id="quizTable">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct Answer</th>
        <th>Topic</th>
        <th>Correct?</th>
        <th>Time Taken (s)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for r in results %}
      <tr data-topic="{{ r.topic }}">
        <td>{{ loop.index }}</td>
        <td>{{ r.question[:40] }}{% if r.question|length > 40 %}...{% endif %}</td>
        <td>{{ r.user_answer }}</td>
        <td>{{ r.correct_answer }}</td>
        <td>{{ r.topic }}</td>
        <td>{% if r.is_correct %}<span class="text-success">‚úÖ</span>{% else %}<span class="text-danger">‚ùå</span>{% endif %}</td>
        <td>{{ r.time_taken }}</td>
        <td>{{ r.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 class="mt-5">üìà Performance Over Time</h3>
  <canvas id="quizChart" height="100"></canvas>
</div>

<!-- JSON Data Embedding -->
<script id="labels-json" type="application/json">{{ labels | tojson | safe }}</script>
<script id="data-json" type="application/json">{{ data | tojson | safe }}</script>

<!-- Chart.js & Interactive Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = JSON.parse(document.getElementById('labels-json').textContent);
  const data = JSON.parse(document.getElementById('data-json').textContent);

  const ctx = document.getElementById('quizChart').getContext('2d');
  const quizChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Correct (1) / Incorrect (0)',
        data: data,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.3,
        pointRadius: 5,
        pointHoverRadius: 7,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.raw === 1 ? '‚úÖ Correct' : '‚ùå Incorrect';
            }
          }
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          stepSize: 1,
          ticks: {
            callback: function(val) {
              return val === 1 ? 'Correct' : 'Incorrect';
            }
          }
        }
      }
    }
  });

  // Interactive table filter
  document.getElementById('topicFilter').addEventListener('change', function () {
    const selected = this.value;
    const rows = document.querySelectorAll('#quizTable tbody tr');
    rows.forEach(row => {
      const topic = row.getAttribute('data-topic');
      row.style.display = (selected === 'All' || topic === selected) ? '' : 'none';
    });
  });
</script>
{% endblock %}
