{% extends 'layout.html' %} {% block content %}
<div class="app-container">
  <div class="main-content" id="main-content">
    <h1 class="main-title">üéì AI-Powered Personalized Learning Assistant</h1>

    <div class="row content-container">
      <!-- Left Column -->
      <div class="col-12 col-lg-3 order-2 order-lg-1">
        <!-- Adaptive Quiz Section -->
        <section class="dashboard-section section-anchor" id="quiz-section">
          <div class="section-header">
            <div class="section-icon">üìù</div>
            <h3 class="section-title">Smart Quiz</h3>
          </div>
          <div class="section-content">
            <button
              id="start-quiz"
              class="btn btn-accent"
              onclick="loadAdaptiveQuestion()"
            >
              üß† Start Adaptive Quiz
            </button>
            <div id="question-box" class="mt-4 hidden">
              <div class="quiz-container">
                <div id="question-content" class="mt-3"></div>
                <button
                  id="next-question-btn"
                  class="btn btn-success mt-3 hidden"
                  onclick="loadAdaptiveQuestion()"
                >
                  üîÅ Next Question
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Section: Recommendation -->
        <section
          class="dashboard-section section-anchor"
          id="recommend-section"
        >
          <div class="section-header">
            <div class="section-icon">üìå</div>
            <h3 class="section-title">Topic Recommendation</h3>
          </div>
          <div class="section-content">
            <button
              id="recommend-button"
              class="btn btn-outline"
              onclick="getRecommendation()"
            >
              üîç Recommend Next Topic
            </button>
            <div id="recommendation-box" class="mt-4 hidden">
              <div class="recommendation-container">
                <p class="font-medium">üìò Your next recommended topic is:</p>
                
                <div id="recommend-box">Loading recommendation...</div>

                <p id="recommended-topic" class="recommendation-topic">
                  Quadratic Equations
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- Section: Progress Dashboard -->
        <section
          class="dashboard-section section-anchor"
          id="dashboard-section"
        >
          <div class="section-header">
            <div class="section-icon">üìä</div>
            <h3 class="section-title" onclick="downloadProgress()">
              My Learning Dashboard
            </h3>
          </div>
          <div class="section-content">
            <div class="chart-container">
              <canvas id="progressChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Section: Download Progress Report -->
        <section class="dashboard-section section-anchor" id="download-section">
          <div class="section-header">
            <div class="section-icon">üì•</div>
            <h3 class="section-title">Download Report</h3>
          </div>
          <div class="section-content text-center">
            <button id="download-button" class="btn btn-outline">
              üì• Download Progress Report (CSV)
            </button>
          </div>
        </section>
      </div>

      <!-- Middle Column -->
      <div class="col-12 col-lg-6 order-1 order-lg-2">
        <!-- Section: Ask AI Tutor -->
        <section class="dashboard-section section-anchor" id="gpt-section">
          <div class="section-header">
            <div class="section-icon">üìö</div>
            <h3 class="section-title">Ask the AI Tutor</h3>
          </div>
          <div class="section-content">
            <div class="input-group">
              <input
                id="gpt-question"
                type="text"
                placeholder="Type your question here..."
                class="input-field"
              />
              <button
                id="ask-button"
                class="btn btn-primary"
                onclick="askTutor()"
              >
                Ask Tutor
              </button>
            </div>

            <div id="gpt-response" class="response-box hidden"></div>
          </div>
        </section>
      </div>

      <!-- Right Column -->
      <div class="col-12 col-lg-3 order-3 order-lg-3">
        <!-- Math Articles Section -->
        <section
          class="dashboard-section section-anchor"
          id="math-articles-section"
        >
          <div class="section-header">
            <div class="section-icon">üìñ</div>
            <h3 class="section-title">Math Articles</h3>
          </div>
          <div class="section-content">
            <ul class="math-articles-list">
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >Understanding Algebraic Expressions</a
                  ></strong
                ><br />
                <small
                  >Learn how to simplify and evaluate algebraic expressions with
                  examples.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >A Beginner‚Äôs Guide to Fractions</a
                  ></strong
                ><br />
                <small
                  >Step-by-step breakdown of how to add, subtract, multiply, and
                  divide fractions.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >What Are Angles? Types and Real-Life Examples</a
                  ></strong
                ><br />
                <small
                  >Discover different types of angles and where they appear in
                  daily life.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >How to Solve Linear Equations</a
                  ></strong
                ><br />
                <small
                  >A simple guide to solving equations like 2x + 3 = 11.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >The Magic of Multiples and Factors</a
                  ></strong
                ><br />
                <small
                  >Understand LCM, HCF, and how they‚Äôre used in math
                  problems.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#" target="_blank"
                    >Why Do We Learn Negative Numbers?</a
                  ></strong
                ><br />
                <small
                  >Explore the concept of negative numbers and their real-world
                  applications.</small
                >
              </li>
              <li>
                <strong
                  ><a href="#"
                    >Introduction to Graphs and Coordinates</a
                  ></strong
                ><br />
                <small
                  >Learn how to read and plot points on a coordinate
                  plane.</small
                >
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let currentCorrectAnswer = "";
  let currentQuestion = "";
  let currentExplanation = "";
  let currentHint = "";
  let attemptCounter = 0;
  const maxAttempts = 3;
  let chartData = {};

  function askTutor() {
    const question = document.getElementById("gpt-question").value;
    const responseBox = document.getElementById("gpt-response");

    fetch("/api/ask-gpt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: question, subject: "math" }),
    })
      .then((res) => res.json())
      .then((data) => {
        responseBox.innerText = data.response;
        responseBox.style.display = "block";
      });
  }

  function loadAdaptiveQuestion() {
    fetch("/api/get-adaptive-question")
      .then((res) => res.json())
      .then((data) => {
        console.log("[DEBUG] Question Data:", data);

        if (data.error || !data.question || !data.answer) {
          alert("‚ùå Could not load quiz question.");
          return;
        }

        currentCorrectAnswer = data.answer.trim().toLowerCase();
        currentExplanation = data.explanation;
        currentHint = data.hint;
        currentQuestion = data.question.trim(); // ‚úÖ Capture the actual question text
        attemptCounter = 0;

        const contentBox = document.getElementById("question-content");
        contentBox.innerHTML = `
          <p><strong>Q:</strong> ${data.question}</p>
          <input type="text" id="userAnswer" class="form-control mt-2" placeholder="Type your answer..." />
          <button class="btn btn-sm btn-primary mt-2" onclick="submitShortAnswer()">Submit</button>
          <div id="feedback" class="mt-2"></div>
        `;

        document.getElementById("question-box").classList.remove("hidden");
        document.getElementById("question-box").style.display = "block";
        console.log("‚úÖ Question box should now be visible");
      })
      .catch((err) => {
        console.error("[ERROR] Fetch failed:", err);
        alert("‚ùå Could not load quiz question.");
      });
  }

  // Old submit answer
  // function submitShortAnswer() {
  //   const input = document.getElementById('userAnswer').value.trim().toLowerCase();
  //   const feedback = document.getElementById('feedback');
  //   const isCorrect = input === currentCorrectAnswer;
  //   const time_taken = Math.floor(Math.random() * 30) + 5;

  //   fetch('/api/submit-answer', {
  //     method: 'POST',
  //     headers: { 'Content-Type': 'application/json' },
  //     body: JSON.stringify({ is_correct: isCorrect, time_taken })
  //   });

  //   if (isCorrect) {
  //     feedback.innerHTML = `<span class='text-success'>‚úÖ Correct!</span>`;
  //   } else {
  //     attemptCounter++;
  //     if (attemptCounter >= maxAttempts) {
  //       feedback.innerHTML = `
  //         <span class='text-danger'>‚ùå Incorrect. You've used all 3 attempts.</span><br>
  //         <strong>‚úÖ Answer:</strong> ${currentCorrectAnswer}<br>
  //         <strong>üìò Explanation:</strong> ${currentExplanation}
  //       `;
  //     } else {
  //       feedback.innerHTML = `
  //         <span class='text-warning'>‚ùå Incorrect. Attempt ${attemptCounter}/${maxAttempts}</span><br>
  //         <strong>üí° Hint:</strong> ${currentHint}
  //       `;
  //     }
  //   }
  // }

  // Submit Answer with GPT
  async function submitShortAnswer() {
    const inputElem = document.getElementById("userAnswer");
    const input = inputElem.value.trim();
    const feedback = document.getElementById("feedback");

    if (!input) {
      // Show feedback immediately without calling the API
      feedback.innerHTML = `<span class="text-warning">‚ö†Ô∏è Please enter an answer before submitting.</span>`;
      inputElem.focus();
      return; // Stop further processing
    }

    const currentAttempt = attemptCounter + 1; // Track what this attempt number is BEFORE incrementing

    const response = await fetch("/api/gpt-feedback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        question: currentQuestion,
        correct_answer: currentCorrectAnswer,
        student_answer: input,
        attempt_num: currentAttempt,
      }),
    });

    const result = await response.json();
    const { is_correct, explanation, hint } = result;

    const time_taken = Math.floor(Math.random() * 30) + 5;

    // Store quiz result
    await fetch("/api/submit-answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ is_correct, time_taken }),
    });

    // console.log(is_correct + "\nExplanation: " + explanation + "\nHint: " + hint + "\nAttempt: "+attemptCounter)

    if (is_correct) {
      feedback.innerHTML = `<span class='text-success'>‚úÖ Correct!</span><br><strong>`;
    } else {
      attemptCounter++;
      if (attemptCounter >= maxAttempts) {
        feedback.innerHTML = `
          <span class='text-danger'>‚ùå Incorrect. You've used all 3 attempts.</span><br>
          <strong>‚úÖ Answer:</strong> ${currentCorrectAnswer}<br>
          <strong>üìò Explanation:</strong> ${explanation}
        `;
      } else {
        feedback.innerHTML = `
          <span class='text-warning'>‚ùå Incorrect. Attempt ${attemptCounter}/${maxAttempts}</span><br>
          <strong>üí° Hint:</strong> ${hint}
        `;
      }
    }
  }

  function getRecommendation() {
    fetch("/api/recommend-topic/1")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById(
          "recommended-topic"
        ).innerText = `üìò Your next recommended topic is: ${data.recommended_topic}`;
      });
  }

  // To get recommendation
  const studentState = { grade: 9, score_avg: 0.7 };
    getRecommendation(studentState);

  function downloadProgress() {
    let csv = "Topic,Accuracy (%)\n";
    for (let i = 0; i < chartData.labels.length; i++) {
      csv += `${chartData.labels[i]},${chartData.accuracies[i]}\n`;
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "progress_report.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Load chart
  fetch("/api/get-progress?user_id=1")
    .then((res) => res.json())
    .then((data) => {
      chartData = data;
      const ctx = document.getElementById("progressChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.labels,
          datasets: [
            {
              label: "Accuracy (%)",
              data: data.accuracies,
              backgroundColor: "rgba(54,162,235,0.6)",
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 },
          },
        },
      });

      document.getElementById("summary-topics").innerText = data.labels.length;
      document.getElementById("summary-xp").innerText = Math.round(
        data.accuracies.reduce((a, b) => a + b, 0)
      );
      document.getElementById("summary-streak").innerText =
        Math.floor(Math.random() * 5 + 1) + " üî•";
    });
</script>
<!-- At the bottom of index.html -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

{% endblock %}
